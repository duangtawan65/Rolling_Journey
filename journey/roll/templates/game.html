{% extends "base.html" %}
{% load static %}

{% block title %}‡πÄ‡∏Å‡∏°{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/game.css' %}">

<div id="background-image-container"></div>

<!-- Start modal -->
<div id="start-game-modal" class="modal-overlay">
  <div class="modal-box">
    <h1 class="modal-title">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡πà‡∏≥‡πÑ‡∏´‡πâ‡πÅ‡∏´‡πà‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏´‡∏•‡πà‡∏°</h1>
    <div class="modal-description">
      <p class="modal-subtitle">
        ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á <strong class="highlight-white">"‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏´‡∏•‡πà‡∏°"</strong> ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏Ç‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏•‡∏Å‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å ‡πÉ‡∏ô‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏≠‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì‡∏£‡πà‡∏≥‡πÑ‡∏´‡πâ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏´‡∏ß‡∏û‡∏£‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏£‡∏≠‡∏î ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏∏‡∏ö‡πÄ‡∏Ç‡∏≤‡∏ô‡∏£‡∏Å‡πÅ‡∏´‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ
      </p>
    </div>
    <hr class="modal-hr">
    <p class="modal-prompt">‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</p>
    <button id="btnConfirmStart" class="modal-button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
  </div>
</div>

<div class="page-wrapper">
  <div class="top-bar">
    <h1 class="username"><i class="fa-solid fa-user"></i> ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô : {{ user.username }}</h1>
    <form method="post" action="{% url 'logout' %}">
      {% csrf_token %}
      <button type="submit" class="button-logout">
        <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </form>
  </div>

  <!-- HUD Left -->
  <div class="hud hud-top-left">
    <div class="resource-bar-item">
      <div class="resource-label">HP</div>
      <div class="resource-bar-container">
        <div class="hp-bar-fill resource-bar-fill" id="hp_fill"></div>
        <span class="resource-bar-text" id="hp_text">- / -</span>
      </div>
    </div>
    <div class="resource-bar-item">
      <div class="resource-label">MP</div>
      <div class="resource-bar-container">
        <div class="mp-bar-fill resource-bar-fill" id="mp_fill"></div>
        <span class="resource-bar-text" id="mp_text">- / -</span>
      </div>
    </div>
  </div>

  <div class="hud-under hud-top-left-under">
    <div class="hud-inventory">
      <div class="inventory-item">
        <div class="item-icon-container">
          <img src="{% static 'icons/1.png' %}" alt="Heal Potion" class="item-icon">
          <span class="item-count" id="potH_count">0</span>
        </div>
        <p class="item-label">Heal Potion</p>
      </div>

      <div class="inventory-item">
        <div class="item-icon-container">
          <img src="{% static 'icons/2.png' %}" alt="Boost Charm" class="item-icon">
          <span class="item-count" id="potB_count">0</span>
        </div>
        <p class="item-label">Boost Charm</p>
      </div>
    </div>
  </div>

  <!-- HUD Right -->
  <div class="hud hud-top-right">
    <div class="char-status-hud">
      <div class="char-status-item">
        <div class="label">üìà ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
        <div id="char_progress" class="value">-</div>
      </div>
      <!-- optional: parsed from narration -->
      <!-- <div class="char-status-item">
        <div class="label">‚ù§Ô∏è ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û(‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</div>
        <div id="char_health" class="value">-</div>
      </div>
      <div class="char-status-item">
        <div class="label">üß† ‡∏™‡∏ï‡∏¥(‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</div>
        <div id="char_sanity" class="value">-</div>
      </div> -->
      <div class="card" id="roll-panel" style="margin-top:12px;">
      <h3>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≠‡∏¢‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤</h3>
      <div style="font-size:48px; font-weight:bold; text-align:center; padding:20px; font-family:'Courier New',monospace;" id="diceResult">-</div>
    </div>
    </div>

    <button id="btnQuit" class="button-quit" type="button">
      ‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ/‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    </button>
  </div>

  <!-- Center -->
  <div class="center-controls">
    <div id="stage_button" class="button">‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà </div>
    <div id="mission-update-box"></div>
    <div id="turn_button" class="button">‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà </div>
  </div>

  <!-- Bottom -->
  <div class="bottom-section">
    <div id="narration-box"></div>
    <div id="choices-box"></div>
    
  </div>
</div>

<script>
{% verbatim %}
// ---------- API endpoints (match your views) ----------
const API = { 
  start: "/api/session/start",
  state: sid => `/api/session/${sid}/state`,
  act:   sid => `/api/session/${sid}/act`,
  end:   sid => `/api/session/${sid}/end`,
  intro: sid => `/api/session/${sid}/intro`,
};

// ---------- Globals ----------
const STORAGE_KEY_SID = 'weingLomSessionID';
let SID = null;

// ---------- Helpers ----------
const el = (id) => document.getElementById(id);
function escapeHtml(s){ 
  return (s||"").replace(/[&<>"']/g, c=>({ 
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" 
  }[c])); 
}
function anonId() { 
  let id = localStorage.getItem("anon_id"); 
  if (!id) { 
    id = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)); 
    localStorage.setItem("anon_id", id); 
  } 
  return id; 
}
async function apiPost(url, body) { 
  const res = await fetch(url, { 
    method: "POST", 
    headers: {"Content-Type": "application/json", "X-ANON-ID": anonId()}, 
    body: body ? JSON.stringify(body) : "{}" 
  }); 
  if (!res.ok) throw new Error(await res.text()); 
  return res.json(); 
}
async function apiGet(url) { 
  const res = await fetch(url, { headers: {"X-ANON-ID": anonId()} }); 
  if (!res.ok) throw new Error(await res.text()); 
  return res.json(); 
}

// ---------- Startup ----------
document.addEventListener('DOMContentLoaded', () => {
  localStorage.removeItem(STORAGE_KEY_SID); // clear old session
  el("start-game-modal").style.display = 'flex';
  el("btnConfirmStart").addEventListener("click", handleStartButtonClick);
  el("btnQuit").addEventListener("click", quitSession);
  updateBackground(0); // initial bg
});

function handleStartButtonClick() {
  const modal = el("start-game-modal");
  modal.style.opacity = "0";
  modal.querySelector(".modal-box").style.transform = "scale(0.95)";
  setTimeout(() => { 
    modal.style.display = "none"; 
    startNewSession(); 
  }, 200);
}

// ---------- Parsing ----------
function extractSceneSituationMissionStatus(narration) {
  let scene = "", situation = "", mission = "", health = "", sanity = "", progress = "";
  if (narration) {
    const missionMatch = narration.match(/\*\*\[‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô\]:\*\*\s*(.*)/);
    if (missionMatch) mission = missionMatch[1].trim();
    const sceneMatch = narration.match(/\*\*\[‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà\]:\*\*\s*(.*)/);
    if (sceneMatch) scene = sceneMatch[1].trim();
    const situationMatch = narration.match(/\*\*\[‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå\]:\*\*\s*([\s\S]*?)(?=\*\*\[|\*\*‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å|\* [A-Z]\.)/);
    if (situationMatch) situation = situationMatch[1].trim();
    const healthMatch = narration.match(/\*\*‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û:\*\*\s*(.*)/);
    if (healthMatch) health = healthMatch[1].trim();
    const sanityMatch = narration.match(/\*\*‡∏™‡∏ï‡∏¥:\*\*\s*(.*)/);
    if (sanityMatch) sanity = sanityMatch[1].trim();
    const progressMatch = narration.match(/\*\*‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à:\*\*\s*\[(.*?)\]/);
    if (progressMatch) progress = progressMatch[1].trim();
  }
  return { scene, situation, mission, health, sanity, progress };
}

// ---------- UI Helpers ----------
function updateBackground(stageIndex) {
  const bgContainer = el("background-image-container");
  if (!stageIndex || stageIndex <= 1) {
    bgContainer.style.backgroundImage = 'url("/static/background/1.png")';
    return;
  }
  const imageUrl = `/static/background/${stageIndex}.png`;
  bgContainer.style.backgroundImage = `url("${imageUrl}")`;
}

function getTurnIndexFromResponse(data) {
  // get_state -> "turn"; act -> "turn_index"
  return (typeof data.turn_index !== "undefined") ? data.turn_index : data.turn;
}

function showRoll(roll) {
  const diceEl = el("diceResult");
  if (!roll || typeof roll.dice_roll === 'undefined') {
    diceEl.textContent = "-";
    return;
  }
  // Show only dice_roll (1-20)
  diceEl.textContent = roll.dice_roll;
}

function renderState(data) {
  SID = data.session_id || SID;

  el("stage_button").textContent = `‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${data.stage_index || '-'}`;

  const turnIndex = getTurnIndexFromResponse(data);
  if (typeof turnIndex !== "undefined") {
    el("turn_button").textContent = `‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà ${turnIndex}`;
  }

  // items
  el("potH_count").textContent = data.player.pot_heal;
  el("potB_count").textContent = data.player.pot_boost;

  // HP/MP bars
  const player = data.player || {};
  const currentHp = player.hp;
  const maxHp = player.max_hp || 30;
  const hpPercentage = (currentHp / maxHp) * 100;
  el('hp_fill').style.width = `${hpPercentage}%`;
  el('hp_text').textContent = `${currentHp} / ${maxHp}`;
  if (hpPercentage < 30) el('hp_fill').classList.add('low-health');
  else el('hp_fill').classList.remove('low-health');

  const currentMp = player.mp;
  const maxMp = player.max_mp || 10;
  const mpPercentage = (currentMp / maxMp) * 100;
  el('mp_fill').style.width = `${mpPercentage}%`;
  el('mp_text').textContent = `${currentMp} / ${maxMp}`;

  // bg
  updateBackground(data.stage_index);
}

function renderNarration(scene, situation) {
  const box = el("narration-box");
  box.innerHTML = `
    <div style="font-size:1.1rem; font-weight: bold; color:#f87171;">${escapeHtml(scene)}</div>
    <div style="margin-top: 0.5rem;">${escapeHtml(situation)}</div>
  `;
  box.scrollTop = 0;
}

function renderMissionStatus(mission, clearedMissionMessage) {
  const box = el("mission-update-box");
  box.innerHTML = `
    ${clearedMissionMessage || ""}
    ${mission ? `<div class="mission-box">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ${escapeHtml(mission)}</div>` : ""}
  `;
}

function renderChoices(narrationText) {
  const box = el("choices-box");
  box.innerHTML = "";
  const lines = (narrationText || "").split("\n");
  const choices = lines
    .filter(s => /^\*\s+[ABC]\.\s+/i.test(s))
    .map(s => s.replace(/^\*\s+[ABC]\.\s+/i, "").trim());
  if (choices.length === 0) return;
  choices.forEach((choice, idx) => {
    const btn = document.createElement("button");
    btn.className = "choice-button";
    btn.innerHTML = `<b>${["A", "B", "C"][idx]}:</b> ${escapeHtml(choice)}`;
    btn.addEventListener("click", () => { 
      document.querySelectorAll('.choice-button').forEach(b => b.disabled = true); 
      doAct(choice); 
    });
    box.appendChild(btn);
  });
}

function processTurnResult(turnResult) {
  const r = turnResult || {};
  // Show dice roll here (ONLY the dice number)
  showRoll(r.roll || null);

  const fullNarrationText = r.narration || "";
  const { scene, situation, mission, health, sanity, progress } =
    extractSceneSituationMissionStatus(fullNarrationText);

  // optional status parsed from narration
  // el('char_health').textContent = health || '-';
  // el('char_sanity').textContent = sanity || '-';
  el('char_progress').textContent = progress ? `[${progress}]` : '-';

  let clearedMissionMessage = "";
  if (r.cleared_stage && mission) {
    clearedMissionMessage = `<div class="mission-cleared-box">üéâ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${escapeHtml(mission)} ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</div>`;
  }

  renderNarration(scene, situation);
  renderMissionStatus(mission, clearedMissionMessage);
  renderChoices(fullNarrationText);
}

// ---------- Flow ----------
async function startNewSession() {
  try {
    el("narration-box").innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà...";
    const data = await apiPost(API.start);
    SID = data.session_id;
    localStorage.setItem(STORAGE_KEY_SID, SID);
    renderState(data);
    showRoll(null); // clear panel
    await loadIntro();
  } catch (e) {
    el("narration-box").innerHTML = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${escapeHtml(e.message)}`;
  }
}

async function continueSession(sessionId) {
  try {
    el("narration-box").innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...";
    const data = await apiGet(API.state(sessionId));
    if (data.status === 'ENDED' || data.status === 'QUIT') { 
      throw new Error("‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß"); 
    }
    SID = sessionId;
    renderState(data);
    if (data.turn) { processTurnResult(data.turn); } else { await loadIntro(); }
  } catch (e) {
    localStorage.removeItem(STORAGE_KEY_SID);
    alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ (${e.message}), ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà`);
    location.reload();
  }
}

async function quitSession() {
  if (!SID && !localStorage.getItem(STORAGE_KEY_SID)) 
    return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ");
  if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  try {
    if (SID) await apiPost(API.end(SID));
  } catch (e) { 
    console.error("Failed to end session on server:", e.message); 
  } finally {
    localStorage.removeItem(STORAGE_KEY_SID);
    location.reload();
  }
}

async function loadIntro() {
  try {
    const res = await apiGet(API.intro(SID));
    showRoll(null); // intro isn't a real roll
    if (res.turn_intro) { processTurnResult(res.turn_intro); }
  } catch(_e) { 
    el("narration-box").innerHTML = "‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"; 
  }
}

async function doAct(actionText) {
  if (!SID) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Session‚Äî‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏Å‡πà‡∏≠‡∏ô");
  // If you want to test buffs: add use_mp/use_boost here.
  const body = { action_text: actionText /*, use_mp: 2, use_boost: true */ };
  try {
    el("narration-box").innerHTML = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: "${escapeHtml(actionText)}"...`;
    const res = await apiPost(API.act(SID), body);
    renderState(res);
    processTurnResult(res.turn);
  } catch (e) {
    el("narration-box").innerHTML = `‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${escapeHtml(e.message)}`;
    document.querySelectorAll('.choice-button').forEach(b => b.disabled = false);
  }
}
{% endverbatim %}
</script>
{% endblock %}