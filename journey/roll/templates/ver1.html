{% extends "base.html" %}
{% block title %}‡πÄ‡∏Å‡∏°{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 p-6">
  <div class="max-w-5xl mx-auto">
    <div class="bg-white rounded-xl shadow p-6">
      <!-- Header -->
      <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
        <h1 class="text-2xl font-bold">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, {{ user.username }} ‚ú®</h1>
        <form method="post" action="{% url 'logout' %}" class="flex gap-2">
          {% csrf_token %}
          <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
          </button>
        </form>
      </div>

      <!-- Status bar -->
      <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-3 mb-4">
        <div class="border rounded-lg p-3"><div class="text-xs text-gray-500">Session</div><div id="sid" class="font-semibold">-</div></div>
        <div class="border rounded-lg p-3"><div class="text-xs text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div><div id="status" class="font-semibold">-</div></div>
        <div class="border rounded-lg p-3"><div class="text-xs text-gray-500">‡∏î‡πà‡∏≤‡∏ô</div><div id="stage" class="font-semibold">-</div></div>
        <div class="border rounded-lg p-3"><div class="text-xs text-gray-500">‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô</div><div id="turn" class="font-semibold">-</div></div>
        <div class="border rounded-lg p-3"><div class="text-xs text-gray-500">HP</div><div id="hp" class="font-semibold">-</div></div>
        <div class="border rounded-lg p-3"><div class="text-xs text-gray-500">MP</div><div id="mp" class="font-semibold">-</div></div>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
        <div class="border rounded-lg p-3"><div class="text-xs text-gray-500">Heal Potion</div><div id="potH" class="font-semibold">-</div></div>
        <div class="border rounded-lg p-3"><div class="text-xs text-gray-500">Boost Charm</div><div id="potB" class="font-semibold">-</div></div>
        <div class="border rounded-lg p-3"><div class="text-xs text-gray-500">‡∏ú‡∏•‡∏ó‡∏≠‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div><div id="lastRoll" class="font-semibold text-sm text-gray-700">-</div></div>
        <div class="border rounded-lg p-3"><div class="text-xs text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö</div><div id="sysmsg" class="font-semibold text-sm text-gray-700">‡∏û‡∏£‡πâ‡∏≠‡∏°</div></div>
      </div>

      <!-- Controls -->
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <button id="btnStart" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700" type="button">‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°</button>
        <button id="btnRefresh" class="bg-gray-200 text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-300" type="button">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button id="btnQuit" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600" type="button">‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ</button>
      </div>

      <!-- Chat window -->
      <div id="chat" class="h-[420px] overflow-y-auto border rounded-xl p-4 bg-gray-50 mb-4">
        <!-- ‡∏ö‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡πÅ‡∏ä‡∏ó‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
      </div>

      <!-- Composer -->
      <div class="space-y-2">
        <textarea id="action_text" class="w-full border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                  rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡πÄ‡∏ä‡πà‡∏ô: ‡πÇ‡∏à‡∏°‡∏ï‡∏µ, ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß, ‡∏ó‡∏≥‡∏û‡∏¥‡∏ò‡∏µ ... (Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á, Shift+Enter ‡∏•‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)"></textarea>
        <div class="flex flex-wrap items-center gap-4">
          <label class="text-sm">‡πÉ‡∏ä‡πâ MP ‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≠‡∏¢:
            <input id="use_mp" type="number" min="0" value="0" class="w-20 border rounded px-2 py-1 ml-1">
          </label>
          <label class="text-sm"><input id="use_heal" type="checkbox" class="mr-1"> ‡πÉ‡∏ä‡πâ Heal</label>
          <label class="text-sm"><input id="use_boost" type="checkbox" class="mr-1"> ‡πÉ‡∏ä‡πâ Boost</label>
          <button id="btnAct" class="ml-auto bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700" type="button">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</button>
        </div>
        <p class="text-xs text-gray-500">‡∏ó‡∏¥‡∏õ: ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô 3/6/9 ‡∏à‡∏∞‡πÉ‡∏ä‡πâ MP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ü‡∏ó‡∏≠‡∏¢‡πÑ‡∏î‡πâ ‡∏´‡∏≤‡∏Å MP ‡∏û‡∏≠</p>
      </div>
    </div>
  </div>
</div>

<script>
  // ---------- API endpoints ----------
  const API = {
    start: "/api/session/start",
    state: sid => `/api/session/${sid}/state`,
    act:   sid => `/api/session/${sid}/act`,
    end:   sid => `/api/session/${sid}/end`,
    intro: sid => `/api/session/${sid}/intro`,   // << ‡∏≠‡∏¥‡∏ô‡πÇ‡∏ó‡∏£‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô (‡πÑ‡∏°‡πà‡∏ó‡∏≠‡∏¢)
  };

  // ---------- Helpers ----------
  function anonId() {
    let id = localStorage.getItem("anon_id");
    if (!id) {
      id = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
      localStorage.setItem("anon_id", id);
    }
    return id;
  }
  async function apiPost(url, body) {
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type": "application/json", "X-ANON-ID": anonId()},
      body: body ? JSON.stringify(body) : "{}",
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }
  async function apiGet(url) {
    const res = await fetch(url, { headers: {"X-ANON-ID": anonId()} });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // ---------- State ----------
  let SID = null;
  let hasLoadedIntro = false; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¥‡∏ô‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  const el = (id) => document.getElementById(id);
  function setSys(msg) { el("sysmsg").textContent = msg; }

  function renderState(data) {
    SID = data.session_id || SID;
    el("sid").textContent = SID || "-";
    el("status").textContent = data.status;
    el("stage").textContent = data.stage_index;

    // turn_index ‡πÉ‡∏´‡∏°‡πà; ‡∏ñ‡πâ‡∏≤ backend ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ data.turn (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
    const turnNum = (data.turn_index != null)
      ? data.turn_index
      : (typeof data.turn === "number" ? data.turn : "-");
    el("turn").textContent = turnNum;

    el("hp").textContent  = data.player.hp;
    el("mp").textContent  = data.player.mp;
    el("potH").textContent= data.player.pot_heal;
    el("potB").textContent= data.player.pot_boost;

    const t = data.turn && data.turn.roll ? data.turn.roll : null;
    el("lastRoll").textContent = t ? `d20=${t.dice_roll} total=${t.total_roll} (${t.tier})` : "-";

    const active = data.status === "ACTIVE";
    el("btnAct").disabled = !active;
    el("action_text").disabled = !active;
  }

  function appendBubble(role, html) {
    const wrap = document.createElement("div");
    wrap.className = "mb-3 flex " + (role === "user" ? "justify-end" : "justify-start");
    const bubble = document.createElement("div");
    bubble.className = (role === "user"
      ? "bg-emerald-600 text-white"
      : "bg-white border") + " max-w-[80%] rounded-2xl px-4 py-3 shadow-sm";
    bubble.innerHTML = html;
    wrap.appendChild(bubble);
    el("chat").appendChild(wrap);
    el("chat").scrollTop = el("chat").scrollHeight;
  }

  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

  function formatNarration(res) {
    const r = res.turn || {};
    const roll = r.roll || {};
    const lines = [];
    if (r.narration) lines.push(`<div class="font-medium whitespace-pre-wrap">${escapeHtml(r.narration)}</div>`);
    if (roll.dice_roll != null) {
      lines.push(`<div class="text-xs text-gray-600 mt-1">üé≤ d20=${roll.dice_roll} ‚Üí total=${roll.total_roll} <span class="font-semibold">(${roll.tier})</span>${roll.mp_spent>0?`, ‡πÉ‡∏ä‡πâ MP=${roll.mp_spent}`:""}${roll.boost_applied?`, Boost +${roll.boost_bonus}`:""}</div>`);
    }
    if (r.cleared_stage) lines.push(`<div class="mt-1 text-xs text-emerald-700">‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!</div>`);
    if (r.cleared_game)  lines.push(`<div class="mt-1 text-xs text-emerald-700 font-semibold">üèÅ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß!</div>`);
    if (r.dead)          lines.push(`<div class="mt-1 text-xs text-red-700 font-semibold">‚ò†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤‡∏¢</div>`);
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ narration ‡∏à‡∏≤‡∏Å act ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if (r.narration) setTimeout(()=>renderChoiceButtons(r.narration), 0);
    return lines.join("");
  }

  function renderChoiceButtons(narr){
    // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏∏‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
    document.querySelectorAll(".choice-row").forEach(n => n.remove());
    // ‡∏î‡∏∂‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î * A./B./C.
    const lines = (narr||"").split("\n");
    const choices = lines.filter(s => /^\*\s+[ABC]\.\s+/i.test(s))
                         .map(s => s.replace(/^\*\s+[ABC]\.\s+/i, "").trim());
    if(choices.length === 0) return;

    const row = document.createElement("div");
    row.className = "choice-row flex flex-wrap gap-2 mb-2 justify-start";
    ["A","B","C"].forEach((label, idx) => {
      if(!choices[idx]) return;
      const btn = document.createElement("button");
      btn.className = "px-3 py-1 rounded-lg border bg-white hover:bg-gray-100 text-sm";
      btn.textContent = `${label}: ${choices[idx]}`;
      btn.addEventListener("click", () => {
        el("action_text").value = choices[idx];
        doAct();
      });
      row.appendChild(btn);
    });
    el("chat").appendChild(row);
    el("chat").scrollTop = el("chat").scrollHeight;
  }

  // ---------- Intro turn (‡πÑ‡∏°‡πà‡∏ó‡∏≠‡∏¢) ----------
  async function loadIntro(){
    if(!SID || hasLoadedIntro) return; // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    try{
      const res = await apiGet(API.intro(SID));
      // ‡∏ö‡∏≤‡∏á backend ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ intro: ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ
      const narration = res?.turn_intro?.narration;
      if(narration){
        appendBubble("bot", `<div class="whitespace-pre-wrap">${escapeHtml(narration)}</div>`);
        renderChoiceButtons(narration);
        hasLoadedIntro = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß
      }
    }catch(_e){ /* ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÑ‡∏ß‡πâ */ }
  }

  // ---------- Actions ----------
  async function startSession() {
    try {
      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏¥‡∏ô‡πÇ‡∏ó‡∏£
      hasLoadedIntro = false;
      
      const data = await apiPost(API.start);
      renderState(data);
      appendBubble("system", `<div class="text-sm text-gray-600">‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div>`);
      await loadIntro(); // ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¥‡∏ô‡πÇ‡∏ó‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      setSys("‡∏û‡∏£‡πâ‡∏≠‡∏°");
    } catch (e) {
      setSys("‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
      alert("Start failed: " + e.message);
    }
  }

  async function refreshState() {
    if (!SID) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Session");
    try {
      const data = await apiGet(API.state(SID));
      renderState(data);
      setSys("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß");
    } catch (e) {
      setSys("‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
      alert("State failed: " + e.message);
    }
  }

  async function quitSession() {
    if (!SID) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Session");
    try {
      await apiPost(API.end(SID));
      appendBubble("system", `<div class="text-sm text-gray-600">‡∏à‡∏ö Session ‡πÅ‡∏•‡πâ‡∏ß</div>`);
      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏¥‡∏ô‡πÇ‡∏ó‡∏£
      hasLoadedIntro = false;
      await refreshState();
    } catch (e) {
      alert("End failed: " + e.message);
    }
  }

  async function doAct() {
    if (!SID) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Session‚Äî‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏Å‡πà‡∏≠‡∏ô");
    const text = el("action_text").value.trim();
    if (!text) return;
    const body = {
      action_text: text,
      use_mp: parseInt(el("use_mp").value || "0", 10),
      use_heal: el("use_heal").checked,
      use_boost: el("use_boost").checked,
    };

    try {
      appendBubble("user", `<div>${escapeHtml(text)}</div>`);

      const res = await apiPost(API.act(SID), body);
      renderState(res);
      appendBubble("bot", formatNarration(res));

      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ó‡∏£‡∏•
      el("action_text").value = "";
      el("use_mp").value = 0;
      el("use_heal").checked = false;
      el("use_boost").checked = false;

      // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¥‡∏ô‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
      
    } catch (e) {
      alert("Act failed: " + e.message);
    }
  }

  // ---------- Wire up ----------
  document.getElementById("btnStart").addEventListener("click", startSession);
  document.getElementById("btnRefresh").addEventListener("click", refreshState);
  document.getElementById("btnQuit").addEventListener("click", quitSession);
  document.getElementById("btnAct").addEventListener("click", doAct);
  el("action_text").addEventListener("keydown", (ev) => {
    if (ev.key === "Enter" && !ev.shiftKey) {
      ev.preventDefault();
      doAct();
    }
  });
</script>
{% endblock %}
