{% extends "base.html" %}
{% load static %} {% block title %}‡πÄ‡∏Å‡∏°{% endblock %}

{% block content %}
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { 
    font-family: 'Prompt', sans-serif;
    color: #111827; 
    overflow: hidden; 
  }
  button { cursor: pointer; border: none;}

  /* --- Background Image Styles --- */
  #background-image-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center center; background-repeat: no-repeat; z-index: -1; transition: background-image 0.7s ease-in-out; filter: brightness(0.6); }

  /* --- Modal Styles --- */
  .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; transition: opacity 0.2s ease-in-out; }
  .modal-box { background-color: #1f2937; color: #d1d5db; border: 1px solid #4b5563; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); padding: 2rem; max-width: 32rem; width: 100%; }
  .modal-title {font-size: 1.875rem; font-weight: 700; color: #ef4444; margin-bottom: 0.5rem; text-align: center; }
  .modal-hr { border-color: #4b5563; margin-bottom: 1.5rem; }
  .modal-prompt { font-size: 1.125rem; color: #f9fafb; margin-bottom: 1.5rem; text-align: center; }
  .modal-button { width: 100%; background-color: #b91c1c; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-size: 1.125rem; font-weight: 700; transition: all 0.2s; }
  .modal-button:hover { background-color: #991b1b; transform: scale(1.05); }

  /* --- New Main Game Layout --- */
  .page-wrapper { position: relative; width: 100vw; height: 100vh; color: white; }
  .top-bar { 
    position: absolute; 
    top: 0; left: 0; 
    width: 100%; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 1rem 1.5rem; 
    background: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0)); 
  }

  .top-bar .username { 
    font-size: 14px; 
    font-weight: 600; 
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7); 
    background-color: rgba(0,0,0,0.6); 
    padding: 0.5rem 1rem; 
    border-radius: 0.5rem; 
  }

  .hud { 
    position: absolute; 
    background-color: rgba(0, 0, 0, 0.6); 
    border: 1px solid rgba(255, 255, 255, 0.2); 
    border-radius: 0.5rem; 
    padding: 1rem; 
    backdrop-filter: blur(5px); 
  }

  .hud-top-left { 
    top: 4rem; 
    left: 1.5rem; 
    display: flex; 
    flex-direction: 
    column; gap: 1rem; 
  }
  .hud-top-right { top: 4rem; right: 1.5rem; width: 250px; }
  
  /* --- HP/MP Bar Styles --- */
  .resource-bar-item { display: flex; flex-direction: column; gap: 4px; }
  .resource-bar-container { 
    width: 200px; 
    height: 20px; 
    background-color: #374151; 
    border-radius: 10px; 
    border: 1px solid #4b5563; 
    position: relative; 
    overflow: hidden; 
  }
  .resource-bar-fill { height: 100%; width: 100%; border-radius: 8px; transition: width 0.5s ease-out, background-color 0.5s ease; }
  .hp-bar-fill { background: linear-gradient(to right, #962f2f, #cc6161); }
  .mp-bar-fill { background: linear-gradient(to right, #223c72, #60a5fa); }
  .hp-bar-fill.low-health { background: linear-gradient(to right, #dc2626, #f87171); }
  .resource-bar-text { 
    position: absolute; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    color: white; 
    font-size: 10px; 
    font-weight: bold; 
    text-shadow: 1px 1px 2px rgba(0,0,0,0.7); 
    white-space: nowrap; 
    font-weight: 300; 
  }
  .resource-label { 
    font-size: 10px; 
    font-weight: 500; 
  }


  /* --- Inventory Styles in HUD --- */
  .hud-inventory { display: flex; gap: 0.75rem; }
  .inventory-item { width: 64px; height: 64px; background: none; border: none; padding: 0; }
  .item-icon-container { position: relative; width: 100%; height: 100%; border-radius: 50%; background-color: rgba(0, 0, 0, 0.4); border: 2px solid #60a5fa; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: 0 0 8px rgba(96, 165, 250, 0.5); }
  .item-icon { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; filter: brightness(0.8) contrast(1.1); }
  .item-count { position: absolute; bottom: 0px; right: 0px; background-color: rgba(0, 0, 0, 0.8); color: white; font-size: 0.7rem; font-weight: bold; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #9ca3af; }
  
  /* --- Center Controls --- */
  .center-controls { 
    position: absolute; 
    top: 20%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    display: column; 
    gap: 10px; 
    text-align: center;
  }
  .button { 
    padding: 5px 5px; 
    border-radius: 0.5rem; 
    color: white; 
    font-weight: 500; 
    transition: background-color 0.2s; 
    background-color: rgba(0,0,0,0.6); 
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(5px); 
    }
  .button:hover { background-color: rgba(0,0,0,0.8); }
  .button-quit { background-color: #dfaa84; }
  .button-quit:hover { background-color: #ea580c; }
  .button-logout { background-color: #dc2626; border: none; }
  .button-logout:hover { background-color: #b91c1c; }

  /* --- Character Status in HUD --- */
  .char-status-hud { display: flex; flex-direction: column; gap: 0.5rem; }
  .char-status-item { display: flex; justify-content: space-between; align-items: center; }
  .char-status-item .label { font-weight: 600; color: #d1d5db; }
  .char-status-item .value { color: #ffffff; font-weight: bold; }

  /* --- Bottom Section (Narration & Choices) --- */
  .bottom-section { position: absolute; bottom: 0; left: 0; width: 100%; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; gap: 1rem; background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0)); }
  #narration-box { width: 100%; max-width: 48rem; height: auto; min-height: 120px; max-height: 200px; background-color: rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 0.75rem; padding: 1rem; overflow-y: auto; }
  #choices-box { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: center; }
  .choice-button { background-color: rgba(25, 33, 46, 0.8); border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px); color: white; padding: 0.75rem 1.5rem; border-radius: 999px; }
  .choice-button:hover { background-color: rgba(255,255,255,0.2); }
  .choice-button:disabled { background-color: rgba(0,0,0,0.4); opacity: 0.6; cursor: not-allowed; }
  .choice-button b { font-weight: 700; }

  /* --- Mission Box Styles --- */
  /* .mission-box, .mission-cleared-box { border-radius: 0.5rem; padding: 0.75rem 1rem; margin: 1rem 0; font-weight: 600; }
  .mission-box { background: #fffbeb; border: 1px solid #facc15; border-left: 5px solid #f59e0b; color: #78350f; }
  .mission-cleared-box { background: #ecfdf5; border: 1px solid #6ee7b7; border-left: 5px solid #10b981; color: #065f46; animation: fadeIn 0.5s ease-in-out; } */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

#turn_button {
  display: none;
}

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à */
.mission-update-box {
  background: #fefce8; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏• */
  border-radius: 1rem; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á */
  padding: 1rem; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á */
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* ‡πÄ‡∏á‡∏≤‡πÄ‡∏ö‡∏≤ */
  font-size: 1rem; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå */
  color: #6b7280; /* ‡∏™‡∏µ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
}

/* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à */
.mission-box {
    padding: 10px 10px; 
    border-radius: 0.5rem; 
    color: white; 
    font-weight: 500; 
    transition: background-color 0.2s; 
    background-color: rgba(192, 164, 40, 0.6); 
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(5px); 
    margin-top: 20px;
}

/* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß */
.mission-cleared-box {
  background-color: #fffedf; 
  /* border-left: 5px solid #10b981;  */
  padding: 0.75rem 1rem; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á */
  color: #065f46; /* ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏° */
  font-weight: 600; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏ô‡πâ‡∏ô */
  font-size: 1rem; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏õ‡∏Å‡∏ï‡∏¥ */
  margin-bottom: 1rem; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏°‡∏≤ */
  border-radius: 0.5rem; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á */
  animation: fadeIn 0.5s ease-in-out; /* ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏õ‡∏£‡∏≤‡∏Å‡∏è */
}

/* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px); /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
  }
  to {
    opacity: 1;
    transform: translateY(0); /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏° */
  }
}

</style>

<div id="background-image-container"></div>

<div id="start-game-modal" class="modal-overlay">
  <div class="modal-box">
    <h1 class="modal-title">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡πà‡∏≥‡πÑ‡∏´‡πâ‡πÅ‡∏´‡πà‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏´‡∏•‡πà‡∏°</h1>
    <div class="modal-description">
      <p>‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á <strong class="highlight-white">"‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏´‡∏•‡πà‡∏°"</strong> ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏Ç‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏•‡∏Å‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å ‡πÉ‡∏ô‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏≠‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì‡∏£‡πà‡∏≥‡πÑ‡∏´‡πâ</p>
      <p>‡πÉ‡∏ä‡πâ‡πÑ‡∏´‡∏ß‡∏û‡∏£‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏£‡∏≠‡∏î ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏∏‡∏ö‡πÄ‡∏Ç‡∏≤‡∏ô‡∏£‡∏Å‡πÅ‡∏´‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ</p>
    </div>
    <hr class="modal-hr">
    <p class="modal-prompt">‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</p>
    <button id="btnConfirmStart" class="modal-button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
  </div>
</div>


<div class="page-wrapper">

  <div class="top-bar">
    <h1 class="username">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô : {{ user.username }}</h1>
    <form method="post" action="{% url 'logout' %}">
      {% csrf_token %}
      <button type="submit" class="button button-logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </form>
  </div>

  <div class="hud hud-top-left">
    <!-- <h1 class="username">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô : {{ user.username }}</h1> -->
    <div class="resource-bar-item">
      <div class="resource-label">HP</div>
      <div class="resource-bar-container">
        <div class="hp-bar-fill resource-bar-fill" id="hp_fill"></div>
        <span class="resource-bar-text" id="hp_text">- / -</span>
      </div>
    </div>
    <div class="resource-bar-item">
      <div class="resource-label">MP</div>
      <div class="resource-bar-container">
        <div class="mp-bar-fill resource-bar-fill" id="mp_fill"></div>
        <span class="resource-bar-text" id="mp_text">- / -</span>
      </div>
    </div>

  </div>

  <div class="hud hud-top-right">
    <div class="hud-inventory">
        <div class="inventory-item">
            <div class="item-icon-container">
                <img src="{% static 'icons/heal_potion.png' %}" alt="Heal Potion Icon" class="item-icon">
                <span class="item-count" id="potH_count">0</span>
            </div>
        </div>
        <div class="inventory-item">
            <div class="item-icon-container">
                <img src="{% static 'icons/boost_charm.png' %}" alt="Boost Charm Icon" class="item-icon">
                <span class="item-count" id="potB_count">0</span>
            </div>
        </div>
    </div>
    <div class="char-status-hud">
      <div class="char-status-item"><div class="label">‚ù§Ô∏è ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div><div id="char_health" class="value">-</div></div>
      <div class="char-status-item"><div class="label">üß† ‡∏™‡∏ï‡∏¥</div><div id="char_sanity" class="value">-</div></div>
      <div class="char-status-item"><div class="label">üìà ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div><div id="char_progress" class="value">-</div></div>
    
    </div>
    <button id="btnQuit" class="button button-quit" type="button">‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ/‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>

  </div>



  <div class="center-controls">
    <div id="stage_button" class="button">‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà </div>
    <div id="mission-update-box" ></div>
    <div id="turn_button" class="button">‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà </div>
  </div>

  <div class="bottom-section">
    <div id="narration-box"></div>
    <div id="choices-box"></div>
  </div>

</div>

<script>
{% verbatim %}
  // ---------- Constants & Globals ----------
  const API = { start: "/api/session/start", state: sid => `/api/session/${sid}/state`, act: sid => `/api/session/${sid}/act`, end: sid => `/api/session/${sid}/end`, intro: sid => `/api/session/${sid}/intro`, };
  const STORAGE_KEY_SID = 'weingLomSessionID';
  let SID = null;

  const BACKGROUND_IMAGES = [
    '/static/bg/1.png', '/static/bg/2.png', '/static/bg/3.png', '/static/bg/4.png', '/static/bg/5.png',
    '/static/bg/6.png', '/static/bg/7.png', '/static/bg/8.png', '/static/bg/9.png', '/static/bg/10.png',
  ];

  // ---------- Helpers ----------
  const el = (id) => document.getElementById(id);
  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
  function anonId() { let id = localStorage.getItem("anon_id"); if (!id) { id = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)); localStorage.setItem("anon_id", id); } return id; }
  async function apiPost(url, body) { const res = await fetch(url, { method: "POST", headers: {"Content-Type": "application/json", "X-ANON-ID": anonId()}, body: body ? JSON.stringify(body) : "{}", }); if (!res.ok) throw new Error(await res.text()); return res.json(); }
  async function apiGet(url) { const res = await fetch(url, { headers: {"X-ANON-ID": anonId()} }); if (!res.ok) throw new Error(await res.text()); return res.json(); }
  
  // ---------- Main Initializer ----------
  document.addEventListener('DOMContentLoaded', () => {
    // ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    localStorage.removeItem(STORAGE_KEY_SID); // ‡∏•‡πâ‡∏≤‡∏á session ‡πÄ‡∏Å‡πà‡∏≤
    el("start-game-modal").style.display = 'flex';
    el("btnConfirmStart").addEventListener("click", handleStartButtonClick);

    el("btnQuit").addEventListener("click", quitSession);
    updateBackground(0);
});

function handleStartButtonClick() {
    const modal = el("start-game-modal");
    modal.style.opacity = "0";
    modal.querySelector(".modal-box").style.transform = "scale(0.95)";
    setTimeout(() => { 
        modal.style.display = "none"; 
        startNewSession(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    }, 200);
}


  // ---------- Data Parsing ----------
  function extractSceneSituationMissionStatus(narration) {
    let scene = "", situation = "", mission = "", health = "", sanity = "", items = "", progress = "";
    if (narration) {
      const missionMatch = narration.match(/\*\*\[‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô\]:\*\*\s*(.*)/);
      if (missionMatch) mission = missionMatch[1].trim();
      const sceneMatch = narration.match(/\*\*\[‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà\]:\*\*\s*(.*)/);
      if (sceneMatch) scene = sceneMatch[1].trim();
      const situationMatch = narration.match(/\*\*\[‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå\]:\*\*\s*([\s\S]*?)(?=\*\*\[|\*\*‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å|\* [A-Z]\.)/);
      if (situationMatch) situation = situationMatch[1].trim();
      const healthMatch = narration.match(/\*\*‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û:\*\*\s*(.*)/);
      if (healthMatch) health = healthMatch[1].trim();
      const sanityMatch = narration.match(/\*\*‡∏™‡∏ï‡∏¥:\*\*\s*(.*)/);
      if (sanityMatch) sanity = sanityMatch[1].trim();
      const progressMatch = narration.match(/\*\*‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à:\*\*\s*\[(.*?)\]/);
      if (progressMatch) progress = progressMatch[1].trim();
    }
    return { scene, situation, mission, health, sanity, progress };
  }

  // ---------- UI Rendering Functions ----------
  function updateBackground(stageIndex) {
    const bgContainer = el("background-image-container");
    const safeIndex = parseInt(stageIndex, 10) || 0;
    let imageUrl = BACKGROUND_IMAGES[safeIndex] || '/static/bg/default.png';
    const newBg = `url("${imageUrl}")`;
    if (bgContainer.style.backgroundImage !== newBg) {
      bgContainer.style.backgroundImage = newBg;
    }
  }

  function renderState(data) {
  SID = data.session_id || SID;
  el("stage_button").textContent = `‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${data.stage_index || '-'}`;
  
  el("potH_count").textContent = data.player.pot_heal;
  el("potB_count").textContent = data.player.pot_boost;
  
  const player = data.player || {};
  const currentHp = player.hp;
  const maxHp = player.max_hp || 30; // <-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô 30
  const hpPercentage = (currentHp / maxHp) * 100;
  el('hp_fill').style.width = `${hpPercentage}%`;
  el('hp_text').textContent = `${currentHp} / ${maxHp}`;
  if (hpPercentage < 30) { el('hp_fill').classList.add('low-health'); } 
  else { el('hp_fill').classList.remove('low-health'); }

  const currentMp = player.mp;
  const maxMp = player.max_mp || 30; // <-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô 30
  const mpPercentage = (currentMp / maxMp) * 100;
  el('mp_fill').style.width = `${mpPercentage}%`;
  el('mp_text').textContent = `${currentMp} / ${maxMp}`;
  
  updateBackground(data.stage_index);
}

function renderNarration(scene, situation) {
  const box = el("narration-box");
  box.innerHTML = `
    <div style="font-size:1.1rem; font-weight: bold; color:#f87171;">${escapeHtml(scene)}</div>
    <div style="margin-top: 0.5rem;">${escapeHtml(situation)}</div>
  `;
  box.scrollTop = 0;
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: renderMissionStatus
function renderMissionStatus(mission, clearedMissionMessage) {
  const box = el("mission-update-box");
  box.innerHTML = `
    ${clearedMissionMessage || ""}
    ${mission ? `<div class="mission-box">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à: ${escapeHtml(mission)}</div>` : ""}
  `;
}

  
  function renderChoices(narrationText) {
    const box = el("choices-box");
    box.innerHTML = "";
    const lines = (narrationText || "").split("\n");
    const choices = lines.filter(s => /^\*\s+[ABC]\.\s+/i.test(s)).map(s => s.replace(/^\*\s+[ABC]\.\s+/i, "").trim());
    if (choices.length === 0) { return; }
    choices.forEach((choice, idx) => {
      const btn = document.createElement("button");
      btn.className = "choice-button";
      btn.innerHTML = `<b>${["A", "B", "C"][idx]}:</b> ${escapeHtml(choice)}`;
      btn.addEventListener("click", () => { document.querySelectorAll('.choice-button').forEach(b => b.disabled = true); doAct(choice); });
      box.appendChild(btn);
    });
  }
  
  function processTurnResult(turnResult) {
    const r = turnResult || {};
    const fullNarrationText = r.narration || "";
    const { scene, situation, mission, health, sanity, progress } = extractSceneSituationMissionStatus(fullNarrationText);
    
    el('char_health').textContent = health || '-';
    el('char_sanity').textContent = sanity || '-';
    el('char_progress').textContent = progress ? `[${progress}]` : '-';

    let clearedMissionMessage = "";
    if (r.cleared_stage && mission) {
      clearedMissionMessage = `<div class="mission-cleared-box">üéâ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${escapeHtml(mission)} ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</div>`;
    }
    
    renderNarration(scene, situation);
    renderMissionStatus(mission, clearedMissionMessage);
    renderChoices(fullNarrationText);
  }

  // ---------- Core Game Actions ----------
  async function startNewSession() {
    try {
      el("narration-box").innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà...";
      const data = await apiPost(API.start);
      SID = data.session_id;
      localStorage.setItem(STORAGE_KEY_SID, SID);
      renderState(data);
      await loadIntro();
    } catch (e) {
      el("narration-box").innerHTML = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${escapeHtml(e.message)}`;
    }
  }

  async function continueSession(sessionId) {
    try {
      el("narration-box").innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...";
      const data = await apiGet(API.state(sessionId));
      if (data.status === 'ENDED' || data.status === 'QUIT') { throw new Error("‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß"); }
      SID = sessionId;
      renderState(data);
      if (data.turn) { processTurnResult(data.turn); } else { await loadIntro(); }
    } catch (e) {
      localStorage.removeItem(STORAGE_KEY_SID);
      alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ (${e.message}), ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà`);
      location.reload();
    }
  }

  async function quitSession() {
    if (!SID && !localStorage.getItem(STORAGE_KEY_SID)) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ");
    if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
    try {
      if (SID) await apiPost(API.end(SID));
    } catch (e) { console.error("Failed to end session on server:", e.message);
    } finally {
      localStorage.removeItem(STORAGE_KEY_SID);
      location.reload();
    }
  }

  async function refreshState() {
    if (!SID) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏Å‡πà‡∏≠‡∏ô"); return; }
    await continueSession(SID);
  }

  async function loadIntro() {
    try {
      const res = await apiGet(API.intro(SID));
      if (res.turn_intro) { processTurnResult(res.turn_intro); }
    } catch(_e) { el("narration-box").innerHTML = "‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"; }
  }

  async function doAct(actionText) {
    if (!SID) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Session‚Äî‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏Å‡πà‡∏≠‡∏ô");
    const body = { action_text: actionText };
    try {
      el("narration-box").innerHTML = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: "${escapeHtml(actionText)}"...`;
      const res = await apiPost(API.act(SID), body);
      renderState(res);
      processTurnResult(res.turn);
    } catch (e) {
      el("narration-box").innerHTML = `‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${escapeHtml(e.message)}`;
      document.querySelectorAll('.choice-button').forEach(b => b.disabled = false);
    }
  }
{% endverbatim %}
</script>
{% endblock %}