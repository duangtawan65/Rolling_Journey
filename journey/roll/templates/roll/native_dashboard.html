<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>The Wailing of Wiang Lom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root{
      --bg:#000000;
      --panel:#0a0a0a;
      --border:#1a1a1a;
      --text:#e0e0e0;
      --text-muted:#666666;
      --accent:#ffffff;
      --danger:#ff0000;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      margin:0;
      padding:32px;
      font-family:'Courier New',Courier,monospace;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
    }
    h1{
      font-size:28px;
      font-weight:400;
      letter-spacing:2px;
      margin:0 0 32px;
      text-transform:uppercase;
      border-bottom:1px solid var(--border);
      padding-bottom:16px;
      color:var(--accent);
    }
    .grid{
      display:grid;
      gap:20px;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      margin-bottom:20px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      padding:20px;
    }
    .card h2{
      font-size:11px;
      font-weight:400;
      margin:0 0 12px;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:1.5px;
    }
    .kpi{
      font-size:48px;
      font-weight:400;
      font-family:'Courier New',monospace;
      color:var(--accent);
      line-height:1;
    }
    .sub{
      color:var(--text-muted);
      font-size:10px;
      margin-top:8px;
      letter-spacing:0.5px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th{
      text-align:left;
      padding:12px 8px;
      border-bottom:1px solid var(--border);
      color:var(--text-muted);
      font-weight:400;
      text-transform:uppercase;
      font-size:10px;
      letter-spacing:1px;
    }
    td{
      padding:12px 8px;
      border-bottom:1px solid var(--border);
      color:var(--text);
    }
    tr:last-child td{
      border-bottom:none;
    }
    canvas{
      width:100% !important;
      height:280px !important;
    }
    .full-width{
      grid-column:1/-1;
    }
  </style>
</head>
<body>
  <h1>The Wailing of Wiang Lom</h1>

  <!-- ตัวชี้วัดหลัก (KPI) -->
  <div class="grid">
    <div class="card">
      <h2>Entrants</h2>
      <div class="kpi">{{ total_entrants }}</div>
      <div class="sub">ผู้เล่นที่เริ่มเล่น</div>
    </div>
    <div class="card">
      <h2>Finishers</h2>
      <div class="kpi">{{ finishers }}</div>
      <div class="sub">ผู้เล่นที่จบเกม</div>
    </div>
    <div class="card">
      <h2>Completion Rate</h2>
      <div class="kpi">{{ completion_rate }}%</div>
      <div class="sub">อัตราการจบเกม</div>
    </div>
    <div class="card">
      <h2>Avg Time to Death</h2>
      <div class="kpi">{{ avg_time_to_death }}s</div>
      <div class="sub">เวลาเฉลี่ยก่อนตาย</div>
    </div>
  </div>

  <!-- เทรนด์รายวัน -->
  <div class="card" style="margin-bottom:20px">
    <h2>Daily Trend: Entrants vs Finishers</h2>
    <canvas id="dailyLine"></canvas>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Active Sessions per Stage</h2>
      <canvas id="eventsPerStage"></canvas>
    </div>
    <div class="card">
      <h2>Average Time per Stage (Seconds)</h2>
      <canvas id="timePerStage"></canvas>
    </div>
  </div>

  <!-- ความตาย -->
  <div class="card full-width" style="margin-top:20px">
    <h2>Deaths by Stage</h2>
    <canvas id="deathByStage"></canvas>
    <div class="sub" style="margin-top:12px">
      Total Deaths: <b>{{ death_total }}</b>
      {% if top_death_stage %} | Most Deadly Stage: <b>Stage {{ top_death_stage }}</b>{% endif %}
    </div>
  </div>

  <!-- ผู้เล่นล่าสุด -->
  <div class="card full-width" style="margin-top:20px">
    <h2>Recent Players</h2>
    <table>
      <thead>
        <tr>
          <th>Player ID</th>
          <th>Rounds</th>
          <th>Last Status</th>
          <th>Last Started</th>
        </tr>
      </thead>
      <tbody>
      {% for p in recent_players %}
        <tr>
          <td>{{ p.player_id }}</td>
          <td>{{ p.rounds }}</td>
          <td>{{ p.last_status }}</td>
          <td>{{ p.last_started }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="4" style="text-align:center;color:var(--text-muted)">ยังไม่มีข้อมูล</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    // ---------- ข้อมูลจาก Django ----------
    const dailyLabels = {{ daily_labels|safe }};
    const dailyEntVals = {{ daily_ent_vals|safe }};
    const dailyFinVals = {{ daily_fin_vals|safe }};

    const stageLabels = {{ stage_labels|safe }};
    const stageCounts = {{ stage_counts|safe }};

    const timeStageLabels = {{ time_stage_labels|safe }};
    const timeStageAvgSec = {{ time_stage_avg_sec|safe }};

    const deathByStage = {{ death_by_stage|safe }};

    const $ = (sel) => document.querySelector(sel);

    // Chart.js global config for horror theme
    Chart.defaults.color = '#666666';
    Chart.defaults.borderColor = '#1a1a1a';
    Chart.defaults.backgroundColor = '#ffffff';
    Chart.defaults.font.family = "'Courier New', monospace";
    Chart.defaults.font.size = 11;

    // ---------- กราฟ ----------
    new Chart($('#dailyLine'), {
      type:'line',
      data:{
        labels: dailyLabels,
        datasets:[
          {
            label:'Entrants',
            data: dailyEntVals,
            borderColor:'#ffffff',
            backgroundColor:'rgba(255,255,255,0.1)',
            borderWidth:1,
            tension:0
          },
          {
            label:'Finishers',
            data: dailyFinVals,
            borderColor:'#666666',
            backgroundColor:'rgba(102,102,102,0.1)',
            borderWidth:1,
            tension:0
          }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          y:{beginAtZero:true, grid:{color:'#1a1a1a'}},
          x:{grid:{color:'#0a0a0a'}}
        },
        plugins:{
          legend:{
            labels:{color:'#666666',font:{size:10}}
          }
        }
      }
    });

    new Chart($('#eventsPerStage'), {
      type:'bar',
      data:{
        labels: stageLabels,
        datasets:[{
          label:'Sessions',
          data: stageCounts,
          backgroundColor:'#ffffff',
          borderColor:'#ffffff',
          borderWidth:1
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{
          y:{beginAtZero:true, grid:{color:'#1a1a1a'}},
          x:{grid:{display:false}}
        }
      }
    });

    new Chart($('#timePerStage'), {
      type:'bar',
      data:{
        labels: timeStageLabels,
        datasets:[{
          label:'Seconds',
          data: timeStageAvgSec,
          backgroundColor:'#ffffff',
          borderColor:'#ffffff',
          borderWidth:1
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{
          y:{beginAtZero:true, grid:{color:'#1a1a1a'}},
          x:{grid:{display:false}}
        }
      }
    });

    new Chart($('#deathByStage'), {
      type:'bar',
      data:{
        labels: deathByStage.map(x=>`Stage ${x.stage_index}`),
        datasets:[{
          label:'Deaths',
          data: deathByStage.map(x=>x.c),
          backgroundColor:'#ff0000',
          borderColor:'#ff0000',
          borderWidth:1
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{
          y:{beginAtZero:true, grid:{color:'#1a1a1a'}},
          x:{grid:{display:false}}
        }
      }
    });
  </script>
</body>
</html>